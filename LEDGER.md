# LEDGER (Project Continuity)

Project: **loom**
Last updated (UTC): 2026-02-09T17:00:00Z

## North Star

A research operating system where BEAM runs on bare metal with fault-tolerant supervision of all components.

## Constraints / invariants

- All kernel modules are pure Erlang — no external C dependencies.
- PE32+ emitter must produce valid UEFI executables (verified by QEMU boot).
- Standalone BEAM parser must have ZERO OTP dependencies (for bare-metal use).
- All machine code is generated byte-by-byte by Erlang — no external assembler or linker.
- Tests live in `tests/`, never mixed with source code.
- Build output goes to `_build/`, never alongside source.

## Current state (what is true right now)

### Directory Structure (OS-style hierarchy)
```
boot/                 UEFI boot (PE32+, fonts, framebuffer)
kernel/{boot,mm,sched,io,arch}    Core kernel subsystems
vm/{interp,parser,jit}            BEAM virtual machine
arch/{x86_64,arm64,ir,link,formats}  Native backends
compat/{syscall,elf,kpi}          Linux compatibility
tests/{kernel,vm,native,data}     All tests separated
tools/                            Scripts and utilities
```

### UEFI Boot Nucleus
- `boot/vbeam_nucleus_boot.erl` (~738 LOC) → 5KB PE32+ .efi
- Boot sequence: EFI entry → serial init → banners → V native code → GOP init → boot splash → HLT
- V function at offset 236 (59 bytes): 38B x86_64 + 24B string data
- GOP framebuffer: 800x600x32bpp, dark purple background, 3x3 loom grid
- VGA 8x16 bitmap font: 1520 bytes, CP437 character set
- Text: "LOOM OS v0.2.0", "V -> BEAM -> x86_64", "Hello from V on BEAM!", "Built with Opus 4.6"
- Boots verified in QEMU with OVMF pflash drives

### BEAM Interpreter
- `vm/interp/vbeam_beam_interp_v2.erl` (~530 LOC) — 30+ opcodes via beam_disasm
- `vm/parser/vbeam_beam_standalone.erl` — standalone parser, no OTP dependencies
- `vm/interp/vbeam_beam_interp_bare.erl` — bare-metal adapted version

### Kernel Modules
- Boot sequence, GDT/IDT, page allocator, paging, heap
- I/O server, IRQ bridge, preemptive scheduler
- BEAM-to-native JIT translator (361 LOC)
- All have corresponding *_test.erl files in `tests/kernel/`

### Linux Compatibility
- ~450 x86_64 syscalls mapped in `compat/syscall/vbeam_linux_syscall.erl`
- Full ELF64 parsing + x86_64 relocations in `compat/elf/vbeam_elf_loader.erl`
- 66 Linux kernel API shims in `compat/kpi/vbeam_linuxkpi.erl`

### Native Backends
- x86_64: 53 privileged instructions (CLI/STI/HLT/CPUID/RDTSC/MOV CR/IRETQ)
- ARM64: 68/68 examples compile (100%)
- IR, register allocator, memory allocator
- PE/ELF/Mach-O object file emitters
- Linker for final executable generation

### Build System
- Modern Makefile with automatic source discovery via wildcard
- Per-subsystem compile targets (boot, kernel, vm, arch, compat)
- Color output with NO_COLOR support, VERBOSE mode
- `_build/` output directory, `make info` for project stats
- 33/33 modules compile successfully

## Decisions

| When | Decision | Rationale |
|------|----------|-----------|
| 2026-02-06 | Generate PE32+ byte-by-byte in Erlang | No external toolchain dependency — self-contained |
| 2026-02-07 | QNX-like supervisor tree architecture | Maps naturally to OTP supervision patterns |
| 2026-02-07 | Process dict for BEAM interpreter state | Clean separation of interpreter instances |
| 2026-02-08 | VGA bitmap font over vector | Simpler at boot time, no FPU needed |
| 2026-02-09 | Separate loom from vbeam repo | Clean separation of compiler vs OS concerns |
| 2026-02-09 | OS-style directory hierarchy | boot/kernel/vm/arch/compat follows Linux/SerenityOS conventions, aids navigation |
| 2026-02-09 | Tests separated from source | Cleaner source tree, standard practice for OS projects |

## Origin

Migrated from `vbeam__v_on_beam` on 2026-02-09. Restructured into OS-style hierarchy same day. Full history remains in the vbeam git log.
