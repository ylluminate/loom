-module(vbeam_font_8x16).
-export([glyph/1, font_binary/0, char_width/0, char_height/0]).
-export([draw_char_code/0, draw_char_2x_code/0, draw_string_code/0]).

%% Return the 16-byte bitmap for a character
-spec glyph(byte()) -> binary().
glyph(Char) when Char >= 32, Char =< 126 ->
    Offset = (Char - 32) * 16,
    binary:part(font_data(), Offset, 16);
glyph(_) ->
    glyph($?).  %% Unknown chars render as '?'

%% Return the complete font as a single binary (for PE embedding)
-spec font_binary() -> binary().
font_binary() -> font_data().

char_width() -> 8.
char_height() -> 16.

%% VGA 8x16 font data - standard IBM PC BIOS font
%% 95 characters (ASCII 32-126), 16 bytes each = 1520 bytes total
%% Each byte is one row, MSB = leftmost pixel
-spec font_data() -> binary().
font_data() ->
    <<
    %% 32 - Space
    16#00,16#00,16#00,16#00,16#00,16#00,16#00,16#00,16#00,16#00,16#00,16#00,16#00,16#00,16#00,16#00,
    %% 33 - !
    16#00,16#00,16#18,16#3C,16#3C,16#3C,16#18,16#18,16#18,16#00,16#18,16#18,16#00,16#00,16#00,16#00,
    %% 34 - "
    16#00,16#00,16#66,16#66,16#66,16#24,16#00,16#00,16#00,16#00,16#00,16#00,16#00,16#00,16#00,16#00,
    %% 35 - #
    16#00,16#00,16#00,16#6C,16#6C,16#FE,16#6C,16#6C,16#6C,16#FE,16#6C,16#6C,16#00,16#00,16#00,16#00,
    %% 36 - $
    16#18,16#18,16#7C,16#C6,16#C2,16#C0,16#7C,16#06,16#06,16#86,16#C6,16#7C,16#18,16#18,16#00,16#00,
    %% 37 - %
    16#00,16#00,16#00,16#00,16#C2,16#C6,16#0C,16#18,16#30,16#60,16#C6,16#86,16#00,16#00,16#00,16#00,
    %% 38 - &
    16#00,16#00,16#38,16#6C,16#6C,16#38,16#76,16#DC,16#CC,16#CC,16#CC,16#76,16#00,16#00,16#00,16#00,
    %% 39 - '
    16#00,16#00,16#30,16#30,16#30,16#60,16#00,16#00,16#00,16#00,16#00,16#00,16#00,16#00,16#00,16#00,
    %% 40 - (
    16#00,16#00,16#0C,16#18,16#30,16#30,16#30,16#30,16#30,16#30,16#18,16#0C,16#00,16#00,16#00,16#00,
    %% 41 - )
    16#00,16#00,16#30,16#18,16#0C,16#0C,16#0C,16#0C,16#0C,16#0C,16#18,16#30,16#00,16#00,16#00,16#00,
    %% 42 - *
    16#00,16#00,16#00,16#00,16#00,16#66,16#3C,16#FF,16#3C,16#66,16#00,16#00,16#00,16#00,16#00,16#00,
    %% 43 - +
    16#00,16#00,16#00,16#00,16#00,16#18,16#18,16#7E,16#18,16#18,16#00,16#00,16#00,16#00,16#00,16#00,
    %% 44 - ,
    16#00,16#00,16#00,16#00,16#00,16#00,16#00,16#00,16#00,16#18,16#18,16#18,16#30,16#00,16#00,16#00,
    %% 45 - -
    16#00,16#00,16#00,16#00,16#00,16#00,16#00,16#FE,16#00,16#00,16#00,16#00,16#00,16#00,16#00,16#00,
    %% 46 - .
    16#00,16#00,16#00,16#00,16#00,16#00,16#00,16#00,16#00,16#00,16#18,16#18,16#00,16#00,16#00,16#00,
    %% 47 - /
    16#00,16#00,16#00,16#00,16#02,16#06,16#0C,16#18,16#30,16#60,16#C0,16#80,16#00,16#00,16#00,16#00,
    %% 48 - 0
    16#00,16#00,16#7C,16#C6,16#C6,16#CE,16#D6,16#D6,16#E6,16#C6,16#C6,16#7C,16#00,16#00,16#00,16#00,
    %% 49 - 1
    16#00,16#00,16#18,16#38,16#78,16#18,16#18,16#18,16#18,16#18,16#18,16#7E,16#00,16#00,16#00,16#00,
    %% 50 - 2
    16#00,16#00,16#7C,16#C6,16#06,16#0C,16#18,16#30,16#60,16#C0,16#C6,16#FE,16#00,16#00,16#00,16#00,
    %% 51 - 3
    16#00,16#00,16#7C,16#C6,16#06,16#06,16#3C,16#06,16#06,16#06,16#C6,16#7C,16#00,16#00,16#00,16#00,
    %% 52 - 4
    16#00,16#00,16#0C,16#1C,16#3C,16#6C,16#CC,16#FE,16#0C,16#0C,16#0C,16#1E,16#00,16#00,16#00,16#00,
    %% 53 - 5
    16#00,16#00,16#FE,16#C0,16#C0,16#C0,16#FC,16#06,16#06,16#06,16#C6,16#7C,16#00,16#00,16#00,16#00,
    %% 54 - 6
    16#00,16#00,16#38,16#60,16#C0,16#C0,16#FC,16#C6,16#C6,16#C6,16#C6,16#7C,16#00,16#00,16#00,16#00,
    %% 55 - 7
    16#00,16#00,16#FE,16#C6,16#06,16#06,16#0C,16#18,16#30,16#30,16#30,16#30,16#00,16#00,16#00,16#00,
    %% 56 - 8
    16#00,16#00,16#7C,16#C6,16#C6,16#C6,16#7C,16#C6,16#C6,16#C6,16#C6,16#7C,16#00,16#00,16#00,16#00,
    %% 57 - 9
    16#00,16#00,16#7C,16#C6,16#C6,16#C6,16#7E,16#06,16#06,16#06,16#0C,16#78,16#00,16#00,16#00,16#00,
    %% 58 - :
    16#00,16#00,16#00,16#00,16#18,16#18,16#00,16#00,16#00,16#18,16#18,16#00,16#00,16#00,16#00,16#00,
    %% 59 - ;
    16#00,16#00,16#00,16#00,16#18,16#18,16#00,16#00,16#00,16#18,16#18,16#30,16#00,16#00,16#00,16#00,
    %% 60 - <
    16#00,16#00,16#00,16#06,16#0C,16#18,16#30,16#60,16#30,16#18,16#0C,16#06,16#00,16#00,16#00,16#00,
    %% 61 - =
    16#00,16#00,16#00,16#00,16#00,16#7E,16#00,16#00,16#7E,16#00,16#00,16#00,16#00,16#00,16#00,16#00,
    %% 62 - >
    16#00,16#00,16#00,16#60,16#30,16#18,16#0C,16#06,16#0C,16#18,16#30,16#60,16#00,16#00,16#00,16#00,
    %% 63 - ?
    16#00,16#00,16#7C,16#C6,16#C6,16#0C,16#18,16#18,16#18,16#00,16#18,16#18,16#00,16#00,16#00,16#00,
    %% 64 - @
    16#00,16#00,16#7C,16#C6,16#C6,16#DE,16#DE,16#DE,16#DC,16#C0,16#C0,16#7C,16#00,16#00,16#00,16#00,
    %% 65 - A
    16#00,16#00,16#10,16#38,16#6C,16#C6,16#C6,16#FE,16#C6,16#C6,16#C6,16#C6,16#00,16#00,16#00,16#00,
    %% 66 - B
    16#00,16#00,16#FC,16#66,16#66,16#66,16#7C,16#66,16#66,16#66,16#66,16#FC,16#00,16#00,16#00,16#00,
    %% 67 - C
    16#00,16#00,16#3C,16#66,16#C2,16#C0,16#C0,16#C0,16#C0,16#C2,16#66,16#3C,16#00,16#00,16#00,16#00,
    %% 68 - D
    16#00,16#00,16#F8,16#6C,16#66,16#66,16#66,16#66,16#66,16#66,16#6C,16#F8,16#00,16#00,16#00,16#00,
    %% 69 - E
    16#00,16#00,16#FE,16#66,16#62,16#68,16#78,16#68,16#60,16#62,16#66,16#FE,16#00,16#00,16#00,16#00,
    %% 70 - F
    16#00,16#00,16#FE,16#66,16#62,16#68,16#78,16#68,16#60,16#60,16#60,16#F0,16#00,16#00,16#00,16#00,
    %% 71 - G
    16#00,16#00,16#3C,16#66,16#C2,16#C0,16#C0,16#DE,16#C6,16#C6,16#66,16#3A,16#00,16#00,16#00,16#00,
    %% 72 - H
    16#00,16#00,16#C6,16#C6,16#C6,16#C6,16#FE,16#C6,16#C6,16#C6,16#C6,16#C6,16#00,16#00,16#00,16#00,
    %% 73 - I
    16#00,16#00,16#3C,16#18,16#18,16#18,16#18,16#18,16#18,16#18,16#18,16#3C,16#00,16#00,16#00,16#00,
    %% 74 - J
    16#00,16#00,16#1E,16#0C,16#0C,16#0C,16#0C,16#0C,16#CC,16#CC,16#CC,16#78,16#00,16#00,16#00,16#00,
    %% 75 - K
    16#00,16#00,16#E6,16#66,16#66,16#6C,16#78,16#78,16#6C,16#66,16#66,16#E6,16#00,16#00,16#00,16#00,
    %% 76 - L
    16#00,16#00,16#F0,16#60,16#60,16#60,16#60,16#60,16#60,16#62,16#66,16#FE,16#00,16#00,16#00,16#00,
    %% 77 - M
    16#00,16#00,16#C6,16#EE,16#FE,16#FE,16#D6,16#C6,16#C6,16#C6,16#C6,16#C6,16#00,16#00,16#00,16#00,
    %% 78 - N
    16#00,16#00,16#C6,16#E6,16#F6,16#FE,16#DE,16#CE,16#C6,16#C6,16#C6,16#C6,16#00,16#00,16#00,16#00,
    %% 79 - O
    16#00,16#00,16#7C,16#C6,16#C6,16#C6,16#C6,16#C6,16#C6,16#C6,16#C6,16#7C,16#00,16#00,16#00,16#00,
    %% 80 - P
    16#00,16#00,16#FC,16#66,16#66,16#66,16#7C,16#60,16#60,16#60,16#60,16#F0,16#00,16#00,16#00,16#00,
    %% 81 - Q
    16#00,16#00,16#7C,16#C6,16#C6,16#C6,16#C6,16#C6,16#C6,16#D6,16#DE,16#7C,16#0C,16#0E,16#00,16#00,
    %% 82 - R
    16#00,16#00,16#FC,16#66,16#66,16#66,16#7C,16#6C,16#66,16#66,16#66,16#E6,16#00,16#00,16#00,16#00,
    %% 83 - S
    16#00,16#00,16#7C,16#C6,16#C6,16#60,16#38,16#0C,16#06,16#C6,16#C6,16#7C,16#00,16#00,16#00,16#00,
    %% 84 - T
    16#00,16#00,16#7E,16#7E,16#5A,16#18,16#18,16#18,16#18,16#18,16#18,16#3C,16#00,16#00,16#00,16#00,
    %% 85 - U
    16#00,16#00,16#C6,16#C6,16#C6,16#C6,16#C6,16#C6,16#C6,16#C6,16#C6,16#7C,16#00,16#00,16#00,16#00,
    %% 86 - V
    16#00,16#00,16#C6,16#C6,16#C6,16#C6,16#C6,16#C6,16#C6,16#6C,16#38,16#10,16#00,16#00,16#00,16#00,
    %% 87 - W
    16#00,16#00,16#C6,16#C6,16#C6,16#C6,16#D6,16#D6,16#D6,16#FE,16#EE,16#6C,16#00,16#00,16#00,16#00,
    %% 88 - X
    16#00,16#00,16#C6,16#C6,16#6C,16#7C,16#38,16#38,16#7C,16#6C,16#C6,16#C6,16#00,16#00,16#00,16#00,
    %% 89 - Y
    16#00,16#00,16#66,16#66,16#66,16#66,16#3C,16#18,16#18,16#18,16#18,16#3C,16#00,16#00,16#00,16#00,
    %% 90 - Z
    16#00,16#00,16#FE,16#C6,16#86,16#0C,16#18,16#30,16#60,16#C2,16#C6,16#FE,16#00,16#00,16#00,16#00,
    %% 91 - [
    16#00,16#00,16#3C,16#30,16#30,16#30,16#30,16#30,16#30,16#30,16#30,16#3C,16#00,16#00,16#00,16#00,
    %% 92 - \
    16#00,16#00,16#00,16#80,16#C0,16#E0,16#70,16#38,16#1C,16#0E,16#06,16#02,16#00,16#00,16#00,16#00,
    %% 93 - ]
    16#00,16#00,16#3C,16#0C,16#0C,16#0C,16#0C,16#0C,16#0C,16#0C,16#0C,16#3C,16#00,16#00,16#00,16#00,
    %% 94 - ^
    16#10,16#38,16#6C,16#C6,16#00,16#00,16#00,16#00,16#00,16#00,16#00,16#00,16#00,16#00,16#00,16#00,
    %% 95 - _
    16#00,16#00,16#00,16#00,16#00,16#00,16#00,16#00,16#00,16#00,16#00,16#00,16#00,16#FF,16#00,16#00,
    %% 96 - `
    16#30,16#18,16#0C,16#00,16#00,16#00,16#00,16#00,16#00,16#00,16#00,16#00,16#00,16#00,16#00,16#00,
    %% 97 - a
    16#00,16#00,16#00,16#00,16#00,16#78,16#0C,16#7C,16#CC,16#CC,16#CC,16#76,16#00,16#00,16#00,16#00,
    %% 98 - b
    16#00,16#00,16#E0,16#60,16#60,16#78,16#6C,16#66,16#66,16#66,16#66,16#7C,16#00,16#00,16#00,16#00,
    %% 99 - c
    16#00,16#00,16#00,16#00,16#00,16#7C,16#C6,16#C0,16#C0,16#C0,16#C6,16#7C,16#00,16#00,16#00,16#00,
    %% 100 - d
    16#00,16#00,16#1C,16#0C,16#0C,16#3C,16#6C,16#CC,16#CC,16#CC,16#CC,16#76,16#00,16#00,16#00,16#00,
    %% 101 - e
    16#00,16#00,16#00,16#00,16#00,16#7C,16#C6,16#FE,16#C0,16#C0,16#C6,16#7C,16#00,16#00,16#00,16#00,
    %% 102 - f
    16#00,16#00,16#38,16#6C,16#64,16#60,16#F0,16#60,16#60,16#60,16#60,16#F0,16#00,16#00,16#00,16#00,
    %% 103 - g
    16#00,16#00,16#00,16#00,16#00,16#76,16#CC,16#CC,16#CC,16#CC,16#CC,16#7C,16#0C,16#CC,16#78,16#00,
    %% 104 - h
    16#00,16#00,16#E0,16#60,16#60,16#6C,16#76,16#66,16#66,16#66,16#66,16#E6,16#00,16#00,16#00,16#00,
    %% 105 - i
    16#00,16#00,16#18,16#18,16#00,16#38,16#18,16#18,16#18,16#18,16#18,16#3C,16#00,16#00,16#00,16#00,
    %% 106 - j
    16#00,16#00,16#06,16#06,16#00,16#0E,16#06,16#06,16#06,16#06,16#06,16#06,16#66,16#66,16#3C,16#00,
    %% 107 - k
    16#00,16#00,16#E0,16#60,16#60,16#66,16#6C,16#78,16#78,16#6C,16#66,16#E6,16#00,16#00,16#00,16#00,
    %% 108 - l
    16#00,16#00,16#38,16#18,16#18,16#18,16#18,16#18,16#18,16#18,16#18,16#3C,16#00,16#00,16#00,16#00,
    %% 109 - m
    16#00,16#00,16#00,16#00,16#00,16#EC,16#FE,16#D6,16#D6,16#D6,16#D6,16#C6,16#00,16#00,16#00,16#00,
    %% 110 - n
    16#00,16#00,16#00,16#00,16#00,16#DC,16#66,16#66,16#66,16#66,16#66,16#66,16#00,16#00,16#00,16#00,
    %% 111 - o
    16#00,16#00,16#00,16#00,16#00,16#7C,16#C6,16#C6,16#C6,16#C6,16#C6,16#7C,16#00,16#00,16#00,16#00,
    %% 112 - p
    16#00,16#00,16#00,16#00,16#00,16#DC,16#66,16#66,16#66,16#66,16#66,16#7C,16#60,16#60,16#F0,16#00,
    %% 113 - q
    16#00,16#00,16#00,16#00,16#00,16#76,16#CC,16#CC,16#CC,16#CC,16#CC,16#7C,16#0C,16#0C,16#1E,16#00,
    %% 114 - r
    16#00,16#00,16#00,16#00,16#00,16#DC,16#76,16#66,16#60,16#60,16#60,16#F0,16#00,16#00,16#00,16#00,
    %% 115 - s
    16#00,16#00,16#00,16#00,16#00,16#7C,16#C6,16#60,16#38,16#0C,16#C6,16#7C,16#00,16#00,16#00,16#00,
    %% 116 - t
    16#00,16#00,16#10,16#30,16#30,16#FC,16#30,16#30,16#30,16#30,16#36,16#1C,16#00,16#00,16#00,16#00,
    %% 117 - u
    16#00,16#00,16#00,16#00,16#00,16#CC,16#CC,16#CC,16#CC,16#CC,16#CC,16#76,16#00,16#00,16#00,16#00,
    %% 118 - v
    16#00,16#00,16#00,16#00,16#00,16#C6,16#C6,16#C6,16#C6,16#C6,16#6C,16#38,16#00,16#00,16#00,16#00,
    %% 119 - w
    16#00,16#00,16#00,16#00,16#00,16#C6,16#C6,16#D6,16#D6,16#D6,16#FE,16#6C,16#00,16#00,16#00,16#00,
    %% 120 - x
    16#00,16#00,16#00,16#00,16#00,16#C6,16#6C,16#38,16#38,16#38,16#6C,16#C6,16#00,16#00,16#00,16#00,
    %% 121 - y
    16#00,16#00,16#00,16#00,16#00,16#C6,16#C6,16#C6,16#C6,16#C6,16#C6,16#7E,16#06,16#0C,16#F8,16#00,
    %% 122 - z
    16#00,16#00,16#00,16#00,16#00,16#FE,16#CC,16#18,16#30,16#60,16#C6,16#FE,16#00,16#00,16#00,16#00,
    %% 123 - {
    16#00,16#00,16#0E,16#18,16#18,16#18,16#70,16#18,16#18,16#18,16#18,16#0E,16#00,16#00,16#00,16#00,
    %% 124 - |
    16#00,16#00,16#18,16#18,16#18,16#18,16#00,16#18,16#18,16#18,16#18,16#18,16#00,16#00,16#00,16#00,
    %% 125 - }
    16#00,16#00,16#70,16#18,16#18,16#18,16#0E,16#18,16#18,16#18,16#18,16#70,16#00,16#00,16#00,16#00,
    %% 126 - ~
    16#00,16#00,16#76,16#DC,16#00,16#00,16#00,16#00,16#00,16#00,16#00,16#00,16#00,16#00,16#00,16#00
    >>.

%% Generate x86_64 machine code for draw_char routine
%% MS x64 calling convention (UEFI):
%%   RCX = framebuffer base address
%%   EDX = x position (pixel)
%%   R8D = y position (pixel)
%%   R9D = character code (ASCII)
%%   [rsp+0x28] = foreground color (BGRA 32-bit)
%%   [rsp+0x30] = background color (BGRA 32-bit)
%%   [rsp+0x38] = pixels_per_scanline (stride in pixels)
%%   [rsp+0x40] = font_data_base address
-spec draw_char_code() -> binary().
draw_char_code() ->
    <<
    %% Prologue - save registers
    16#55,                              %% push rbp
    16#48, 16#89, 16#E5,                %% mov rbp, rsp
    16#41, 16#57,                       %% push r15
    16#41, 16#56,                       %% push r14
    16#41, 16#55,                       %% push r13
    16#41, 16#54,                       %% push r12
    16#53,                              %% push rbx
    16#48, 16#83, 16#EC, 16#10,         %% sub rsp, 16  ; stack space

    %% Load parameters
    16#49, 16#89, 16#CC,                %% mov r12, rcx  ; r12 = fb_base
    16#44, 16#89, 16#C3,                %% mov ebx, r8d  ; ebx = y
    16#89, 16#D6,                       %% mov esi, edx  ; esi = x
    16#44, 16#89, 16#CF,                %% mov edi, r9d  ; edi = char
    16#44, 16#8B, 16#6D, 16#30,         %% mov r13d, [rbp+0x30]  ; r13d = fg_color
    16#44, 16#8B, 16#75, 16#38,         %% mov r14d, [rbp+0x38]  ; r14d = bg_color
    16#44, 16#8B, 16#7D, 16#40,         %% mov r15d, [rbp+0x40]  ; r15d = stride
    16#4C, 16#8B, 16#45, 16#48,         %% mov r8, [rbp+0x48]    ; r8 = font_base

    %% Clamp char to 32-126, default to '?' if out of range
    16#83, 16#FF, 16#20,                %% cmp edi, 32
    16#7C, 16#05,                       %% jl use_question_mark (+5 to +54)
    16#83, 16#FF, 16#7E,                %% cmp edi, 126
    16#7E, 16#05,                       %% jle char_ok (+5 to +59)
                                        %% use_question_mark:
    16#BF, 16#3F, 16#00, 16#00, 16#00,  %% mov edi, 63  ; '?'
                                        %% char_ok:

    %% Calculate glyph offset: (char - 32) * 16
    16#83, 16#EF, 16#20,                %% sub edi, 32
    16#C1, 16#E7, 16#04,                %% shl edi, 4   ; *16
    16#49, 16#01, 16#F8,                %% add r8, rdi  ; r8 = glyph_ptr

    %% Calculate initial framebuffer position
    %% fb_ptr = fb_base + (y * stride + x) * 4
    16#89, 16#D8,                       %% mov eax, ebx  ; eax = y
    16#41, 16#0F, 16#AF, 16#C7,         %% imul eax, r15d  ; eax = y * stride
    16#01, 16#F0,                       %% add eax, esi  ; eax = y * stride + x
    16#C1, 16#E0, 16#02,                %% shl eax, 2    ; *4 (bytes per pixel)
    16#48, 16#98,                       %% cdqe          ; sign extend to rax
    16#4C, 16#01, 16#E0,                %% add rax, r12  ; rax = fb_ptr

    %% Calculate stride in bytes
    16#41, 16#C1, 16#E7, 16#02,         %% shl r15d, 2   ; stride *= 4

    %% Loop through 16 rows
    16#B9, 16#10, 16#00, 16#00, 16#00,  %% mov ecx, 16   ; row counter
                                        %% row_loop:
    16#48, 16#89, 16#C2,                %% mov rdx, rax  ; rdx = row_fb_ptr
    16#41, 16#0F, 16#B6, 16#30,         %% movzx esi, byte [r8]  ; load glyph byte
    16#49, 16#FF, 16#C0,                %% inc r8        ; advance glyph ptr

    %% Loop through 8 bits (columns)
    16#BB, 16#08, 16#00, 16#00, 16#00,  %% mov ebx, 8    ; bit counter
                                        %% bit_loop:
    16#40, 16#00, 16#F6,                %% add sil, sil  ; shift byte left, CF = MSB (8-bit)
    16#73, 16#05,                       %% jnc use_bg    ; if bit clear, use bg (+5 to byte 118)
                                        %% use_fg:
    16#44, 16#89, 16#2A,                %% mov [rdx], r13d  ; write fg_color
    16#EB, 16#03,                       %% jmp next_bit (+3 to byte 121)
                                        %% use_bg:
    16#44, 16#89, 16#32,                %% mov [rdx], r14d  ; write bg_color
                                        %% next_bit:
    16#48, 16#83, 16#C2, 16#04,         %% add rdx, 4    ; advance to next pixel
    16#FF, 16#CB,                       %% dec ebx
    16#75, 16#EB,                       %% jnz bit_loop (-21 to byte 108)

    %% Advance to next row
    16#49, 16#63, 16#D7,                %% movsxd rdx, r15d  ; sign extend stride
    16#48, 16#01, 16#D0,                %% add rax, rdx  ; fb_ptr += stride
    16#FF, 16#C9,                       %% dec ecx
    16#75, 16#D2,                       %% jnz row_loop (-46 to byte 93)

    %% Epilogue
    16#48, 16#83, 16#C4, 16#10,         %% add rsp, 16
    16#5B,                              %% pop rbx
    16#41, 16#5C,                       %% pop r12
    16#41, 16#5D,                       %% pop r13
    16#41, 16#5E,                       %% pop r14
    16#41, 16#5F,                       %% pop r15
    16#5D,                              %% pop rbp
    16#C3                               %% ret
    >>.

%% Generate x86_64 machine code for 2x scaled draw_char routine (170 bytes)
%% Same calling convention as draw_char_code(), but renders each glyph pixel
%% as a 2x2 block, producing 16x32 output per character.
-spec draw_char_2x_code() -> binary().
draw_char_2x_code() ->
    <<
    %% Prologue (17 bytes, offset 0-16)
    16#55,                              %% 0: push rbp
    16#48, 16#89, 16#E5,                %% 1: mov rbp, rsp
    16#41, 16#57,                       %% 4: push r15
    16#41, 16#56,                       %% 6: push r14
    16#41, 16#55,                       %% 8: push r13
    16#41, 16#54,                       %% 10: push r12
    16#53,                              %% 12: push rbx
    16#48, 16#83, 16#EC, 16#10,         %% 13: sub rsp, 16

    %% Load parameters (27 bytes, offset 17-43)
    16#49, 16#89, 16#CC,                %% 17: mov r12, rcx  ; r12 = fb_base
    16#44, 16#89, 16#C3,                %% 20: mov ebx, r8d  ; ebx = y
    16#89, 16#D6,                       %% 23: mov esi, edx  ; esi = x
    16#44, 16#89, 16#CF,                %% 25: mov edi, r9d  ; edi = char
    16#44, 16#8B, 16#6D, 16#30,         %% 28: mov r13d, [rbp+0x30]  ; fg_color
    16#44, 16#8B, 16#75, 16#38,         %% 32: mov r14d, [rbp+0x38]  ; bg_color
    16#44, 16#8B, 16#7D, 16#40,         %% 36: mov r15d, [rbp+0x40]  ; stride
    16#4C, 16#8B, 16#45, 16#48,         %% 40: mov r8, [rbp+0x48]    ; font_base

    %% Clamp char 32-126 (15 bytes, offset 44-58)
    16#83, 16#FF, 16#20,                %% 44: cmp edi, 32
    16#7C, 16#05,                       %% 47: jl use_qmark (+5 to 54)
    16#83, 16#FF, 16#7E,                %% 49: cmp edi, 126
    16#7E, 16#05,                       %% 52: jle char_ok (+5 to 59)
    16#BF, 16#3F, 16#00, 16#00, 16#00,  %% 54: mov edi, 63  ; '?'

    %% Glyph offset (9 bytes, offset 59-67)
    16#83, 16#EF, 16#20,                %% 59: sub edi, 32
    16#C1, 16#E7, 16#04,                %% 62: shl edi, 4
    16#49, 16#01, 16#F8,                %% 65: add r8, rdi

    %% Initial fb position (16 bytes, offset 68-83)
    16#89, 16#D8,                       %% 68: mov eax, ebx
    16#41, 16#0F, 16#AF, 16#C7,         %% 70: imul eax, r15d
    16#01, 16#F0,                       %% 74: add eax, esi
    16#C1, 16#E0, 16#02,                %% 76: shl eax, 2
    16#48, 16#98,                       %% 79: cdqe
    16#4C, 16#01, 16#E0,                %% 81: add rax, r12

    %% Stride to bytes (4 bytes, offset 84-87)
    16#41, 16#C1, 16#E7, 16#02,         %% 84: shl r15d, 2

    %% Row counter (5 bytes, offset 88-92)
    16#B9, 16#10, 16#00, 16#00, 16#00,  %% 88: mov ecx, 16

    %% row_loop: (offset 93) — 2 scanlines per glyph row
    16#40, 16#B7, 16#02,                %% 93: mov dil, 2  ; scanline counter

    %% scanline_loop: (offset 96)
    16#48, 16#89, 16#C2,                %% 96: mov rdx, rax
    16#41, 16#0F, 16#B6, 16#30,         %% 99: movzx esi, byte [r8]
    16#BB, 16#08, 16#00, 16#00, 16#00,  %% 103: mov ebx, 8

    %% bit_loop: (offset 108) — write 2 pixels per bit
    16#40, 16#00, 16#F6,                %% 108: add sil, sil
    16#73, 16#09,                       %% 111: jnc use_bg (+9 to 122)
    16#44, 16#89, 16#2A,                %% 113: mov [rdx], r13d    ; fg pixel 1
    16#44, 16#89, 16#6A, 16#04,         %% 116: mov [rdx+4], r13d  ; fg pixel 2
    16#EB, 16#07,                       %% 120: jmp next_bit (+7 to 129)
    %% use_bg: (offset 122)
    16#44, 16#89, 16#32,                %% 122: mov [rdx], r14d    ; bg pixel 1
    16#44, 16#89, 16#72, 16#04,         %% 125: mov [rdx+4], r14d  ; bg pixel 2
    %% next_bit: (offset 129)
    16#48, 16#83, 16#C2, 16#08,         %% 129: add rdx, 8  ; advance 2 pixels
    16#FF, 16#CB,                       %% 133: dec ebx
    16#75, 16#E3,                       %% 135: jnz bit_loop (-29 to 108)

    %% Advance scanline (offset 137)
    16#49, 16#63, 16#D7,                %% 137: movsxd rdx, r15d
    16#48, 16#01, 16#D0,                %% 140: add rax, rdx
    16#40, 16#FE, 16#CF,                %% 143: dec dil
    16#75, 16#CC,                       %% 146: jnz scanline_loop (-52 to 96)

    %% Next glyph row (offset 148)
    16#49, 16#FF, 16#C0,                %% 148: inc r8
    16#FF, 16#C9,                       %% 151: dec ecx
    16#75, 16#C2,                       %% 153: jnz row_loop (-62 to 93)

    %% Epilogue (15 bytes, offset 155-169)
    16#48, 16#83, 16#C4, 16#10,         %% 155: add rsp, 16
    16#5B,                              %% 159: pop rbx
    16#41, 16#5C,                       %% 160: pop r12
    16#41, 16#5D,                       %% 162: pop r13
    16#41, 16#5E,                       %% 164: pop r14
    16#41, 16#5F,                       %% 166: pop r15
    16#5D,                              %% 168: pop rbp
    16#C3                               %% 169: ret
    >>.

%% Generate x86_64 machine code for draw_string routine
%% MS x64 calling convention:
%%   RCX = framebuffer base address
%%   EDX = x position (pixel)
%%   R8D = y position (pixel)
%%   R9  = string pointer (null-terminated)
%%   [rsp+0x28] = foreground color
%%   [rsp+0x30] = background color
%%   [rsp+0x38] = pixels_per_scanline
%%   [rsp+0x40] = font_data_base
%%   [rsp+0x48] = draw_char function pointer
-spec draw_string_code() -> binary().
draw_string_code() ->
    <<
    %% Prologue
    16#55,                              %% push rbp
    16#48, 16#89, 16#E5,                %% mov rbp, rsp
    16#41, 16#57,                       %% push r15
    16#41, 16#56,                       %% push r14
    16#41, 16#55,                       %% push r13
    16#41, 16#54,                       %% push r12
    16#53,                              %% push rbx
    16#48, 16#83, 16#EC, 16#30,         %% sub rsp, 48  ; shadow space + locals

    %% Save parameters
    16#49, 16#89, 16#CC,                %% mov r12, rcx  ; r12 = fb_base
    16#41, 16#89, 16#D5,                %% mov r13d, edx ; r13d = x
    16#41, 16#89, 16#C6,                %% mov r14d, r8d ; r14d = y
    16#49, 16#89, 16#CF,                %% mov r15, r9   ; r15 = string_ptr

    %% string_loop:
                                        %% string_loop:
    16#41, 16#0F, 16#B6, 16#1F,         %% movzx ebx, byte [r15]  ; load char
    16#84, 16#DB,                       %% test bl, bl
    16#74, 16#3E,                       %% jz done       ; if null terminator, done

    %% Set up draw_char call parameters
    16#4C, 16#89, 16#E1,                %% mov rcx, r12  ; rcx = fb_base
    16#44, 16#89, 16#EA,                %% mov edx, r13d ; edx = x
    16#45, 16#89, 16#F0,                %% mov r8d, r14d ; r8d = y
    16#41, 16#89, 16#D9,                %% mov r9d, ebx  ; r9d = char

    %% Copy stack parameters
    16#8B, 16#45, 16#30,                %% mov eax, [rbp+0x30]  ; fg_color
    16#89, 16#44, 16#24, 16#28,         %% mov [rsp+0x28], eax
    16#8B, 16#45, 16#38,                %% mov eax, [rbp+0x38]  ; bg_color
    16#89, 16#44, 16#24, 16#30,         %% mov [rsp+0x30], eax
    16#8B, 16#45, 16#40,                %% mov eax, [rbp+0x40]  ; stride
    16#89, 16#44, 16#24, 16#38,         %% mov [rsp+0x38], eax
    16#48, 16#8B, 16#45, 16#48,         %% mov rax, [rbp+0x48]  ; font_base
    16#48, 16#89, 16#44, 16#24, 16#40,  %% mov [rsp+0x40], rax

    %% Call draw_char
    16#48, 16#8B, 16#45, 16#50,         %% mov rax, [rbp+0x50]  ; draw_char ptr
    16#FF, 16#D0,                       %% call rax

    %% Advance x by 8 pixels, move to next char
    16#41, 16#83, 16#C5, 16#08,         %% add r13d, 8
    16#49, 16#FF, 16#C7,                %% inc r15
    16#EB, 16#B9,                       %% jmp string_loop

                                        %% done:
    16#48, 16#83, 16#C4, 16#30,         %% add rsp, 48
    16#5B,                              %% pop rbx
    16#41, 16#5C,                       %% pop r12
    16#41, 16#5D,                       %% pop r13
    16#41, 16#5E,                       %% pop r14
    16#41, 16#5F,                       %% pop r15
    16#5D,                              %% pop rbp
    16#C3                               %% ret
    >>.
